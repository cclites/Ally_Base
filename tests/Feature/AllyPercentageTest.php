<?php

namespace Tests\Feature;

use App\Billing\BillingCalculator;
use App\Client;
use Tests\CreatesClientInvoiceResources;
use Tests\TestCase;
use Illuminate\Foundation\Testing\RefreshDatabase;

class AllyPercentageTest extends TestCase
{
    use RefreshDatabase;
    use CreatesClientInvoiceResources;

    /**
     *
     */
    protected function setUp()
    {
        parent::setUp(); // TODO: Change the autogenerated stub
        $this->client = factory(Client::class)->create();

    }

    /**
     * @test
     */
    public function a_private_pay_client_with_provider_pay_is_3()
    {
        $this->createPrivateBalancePayer();
        $this->client->setPaymentMethod($this->client->business);

        $this->assertEquals(BillingCalculator::getBankAccountRate(), $this->client->getAllyPercentage());
    }


    /**
     * @test
     */
    public function a_private_pay_client_with_credit_card_is_5()
    {
        $this->createPrivateBalancePayer();
        $this->client->setPaymentMethod($this->createCreditCard('visa'));

        $this->assertEquals(BillingCalculator::getCreditCardRate(), $this->client->getAllyPercentage());
    }

    /**
     * @test
     */
    public function a_private_pay_client_with_amex_is_6()
    {
        $this->createPrivateBalancePayer();
        $this->client->setPaymentMethod($this->createCreditCard('amex'));

        $this->assertEquals(BillingCalculator::getAmexRate(), $this->client->getAllyPercentage());
    }

    /**
     * @test
     */
    public function a_balance_payer_with_provider_pay_is_3()
    {
        $clientPayer = $this->createBalancePayer();
        $clientPayer->payer->setProviderPay();

        $this->assertEquals(BillingCalculator::getBankAccountRate(), $this->client->getAllyPercentage());
    }

    /**
     * @test
     */
    public function a_split_payer_uses_the_higher_priority()
    {
        $clientPayer1 = $this->createPrivateSplitPayer(0.50);
        $clientPayer1->update(['priority' => 2]);
        $clientPayer2 = $this->createSplitPayer(0.50);
        $clientPayer2->payer->setProviderPay();

        $this->assertEquals(BillingCalculator::getBankAccountRate(), $this->client->getAllyPercentage());
    }
}
